<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mentor Dashboard - Coding Questions Finder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="top-nav">
        <div class="top-nav-inner">
            <a href="/" class="brand"><i class="fas fa-code"></i> <span>Coding Easy-Placement Easy</span></a>
            <div class="nav-links">
                <span class="nav-link" style="pointer-events:none; background:#edf2f7;">Mentor Dashboard</span>
            </div>
            <div class="nav-actions">
                <a href="{{ url_for('logout') }}" class="btn btn-primary"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="user-info">
                    <div class="user-details">
                        <span class="welcome-text">Welcome, <strong>{{ user }}</strong>!</span>
                        <span class="user-type-badge user-type-{{ user_type }}">{{ user_type.title() }}</span>
                    </div>
                    <a href="{{ url_for('logout') }}" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
                <h1 class="title">
                    <i class="fas fa-chalkboard-teacher"></i>
                    Coding Easy-Placement Easy — Mentor Dashboard
                </h1>
                <p class="subtitle">Find questions and manage published content for students</p>
            </div>
        </header>

        <main class="main-content">
            <!-- Question Finder Section -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-search"></i> Question Finder</h2>
                    <p>Search for coding questions and save them for publishing</p>
                </div>
                
                <div class="search-container">
                    <form id="searchForm" class="search-form">
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="queryInput" 
                                placeholder="Enter your coding question or topic..." 
                                class="search-input"
                                required
                            >
                            <button type="submit" class="search-btn" id="searchBtn">
                                <i class="fas fa-search"></i>
                                <span>Search</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="results-section" id="resultsSection" style="display: none;">
                    <div class="summary-card" id="summaryCard">
                        <h3><i class="fas fa-lightbulb"></i> Query Summary</h3>
                        <p id="summaryText"></p>
                    </div>

                    <div class="questions-container">
                        <h3 class="questions-title">
                            <i class="fas fa-list"></i>
                            Top 5 Related Questions
                        </h3>
                        <div class="questions-grid" id="questionsGrid">
                            <!-- Questions will be populated here -->
                        </div>
                        
                        <div class="save-section">
                            <button id="saveSearchBtn" class="save-btn">
                                <i class="fas fa-save"></i>
                                Save Search Results
                            </button>
                        </div>
                    </div>
                </div>

                <div class="loading" id="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Finding the best questions for you...</p>
                </div>

                <div class="error" id="error" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p id="errorMessage"></p>
                </div>
            </div>

            <!-- Question Management Section -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-tasks"></i> Question Management</h2>
                    <p>Manage your saved questions and publish them for students</p>
                </div>

                <div class="questions-management">
                    {% if saved_questions %}
                        <div class="saved-questions-grid">
                            {% for question in saved_questions %}
                            <div class="saved-question-card" data-question-id="{{ question.id }}">
                                <div class="question-header">
                                    <h4>{{ question.query }}</h4>
                                    <div class="question-status">
                                        {% if question.is_published %}
                                            <span class="status-badge published">Published</span>
                                        {% else %}
                                            <span class="status-badge draft">Draft</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="question-summary">
                                    <p>{{ question.summary }}</p>
                                </div>
                                
                                <div class="question-actions">
                                    <button class="action-btn view-btn" onclick="viewQuestion('{{ question.id }}')">
                                        <i class="fas fa-eye"></i>
                                        View
                                    </button>
                                    
                                    {% if question.is_published %}
                                        <button class="action-btn unpublish-btn" onclick="togglePublish('{{ question.id }}', 'unpublish')">
                                            <i class="fas fa-eye-slash"></i>
                                            Unpublish
                                        </button>
                                    {% else %}
                                        <button class="action-btn publish-btn" onclick="togglePublish('{{ question.id }}', 'publish')">
                                            <i class="fas fa-share"></i>
                                            Publish
                                        </button>
                                    {% endif %}
                                    
                                    <button class="action-btn delete-btn" onclick="deleteQuestion('{{ question.id }}')">
                                        <i class="fas fa-trash"></i>
                                        Delete
                                    </button>
                                </div>
                                
                                <div class="question-meta">
                                    <small>Created: {{ question.formatted_created_at }}</small>
                                    {% if question.published_at %}
                                        <small>Published: {{ question.formatted_published_at }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No saved questions yet</h3>
                            <p>Use the Question Finder above to search and save questions for your students.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Mentor Dashboard • Manage questions for your students</p>
        </footer>
    </div>

    <!-- Question Modal -->
    <div id="questionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Question Details</h3>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Question details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        let currentSearchData = null;

        // Search functionality
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;
            
            // Show loading state
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            
            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });
                
                const contentType = response.headers.get('content-type') || '';
                let data = null;
                if (contentType.includes('application/json')) {
                    try {
                        data = await response.json();
                    } catch (e) {
                        showError('Invalid JSON from server. Please try again.');
                        return;
                    }
                } else {
                    const text = await response.text();
                    showError(text || 'Unexpected response from server.');
                    return;
                }

                if (!response.ok) {
                    showError((data && (data.error || data.message)) || 'Request failed.');
                    return;
                }

                if (data.success) {
                    currentSearchData = data;
                    displayResults(data.summary, data.questions);
                } else {
                    showError(data.error || 'Search failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
            }
        });
        
        function displayResults(summary, questions) {
            // Show summary
            document.getElementById('summaryText').textContent = summary;
            
            // Display questions
            const questionsGrid = document.getElementById('questionsGrid');
            questionsGrid.innerHTML = '';
            
            questions.forEach((question, index) => {
                const questionCard = createQuestionCard(question, index + 1);
                questionsGrid.appendChild(questionCard);
            });
            
            // Show results
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        function createQuestionCard(question, index) {
            const card = document.createElement('div');
            card.className = 'question-card';
            
            const difficultyClass = question.difficulty_level.toLowerCase();
            
            // URL is already validated by backend - use it directly
            const problemUrl = question.url || '#';
            
            card.innerHTML = `
                <div class="question-header">
                    <span class="question-number">${index}</span>
                    <div class="platform-badge platform-${question.platform.toLowerCase().replace(' ', '-')}">
                        ${question.platform}
                    </div>
                </div>
                
                <div class="question-content">
                    <h4 class="question-topic">${question.topic}</h4>
                    <p class="question-category">${question.category}</p>
                </div>
                
                <div class="question-meta">
                    <div class="difficulty difficulty-${difficultyClass}">
                        <i class="fas fa-signal"></i>
                        ${question.difficulty_level}
                    </div>
                    <div class="company">
                        <i class="fas fa-building"></i>
                        ${question.company}
                    </div>
                </div>
                
                <a href="${problemUrl}" target="_blank" rel="noopener noreferrer" class="question-link">
                    <i class="fas fa-external-link-alt"></i>
                    View Problem
                </a>
            `;
            
            return card;
        }
        
        // Save search results
        document.getElementById('saveSearchBtn').addEventListener('click', async function() {
            if (!currentSearchData) {
                showError('No search results to save');
                return;
            }
            
            const saveBtn = document.getElementById('saveSearchBtn');
            const originalText = saveBtn.innerHTML;
            
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Saving...</span>';
            saveBtn.disabled = true;
            
            try {
                const response = await fetch('/save_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: document.getElementById('queryInput').value,
                        summary: currentSearchData.summary,
                        questions: currentSearchData.questions
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Search results saved successfully!');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showError(data.message || 'Failed to save search results');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        });
        
        // Toggle publish/unpublish
        async function togglePublish(questionId, action) {
            try {
                const response = await fetch('/publish_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                            question_id: Number(questionId),
                            action: action
                        })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showError(data.message || 'Action failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }
        
        // Delete question
        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question?')) {
                return;
            }
            
            try {
                const response = await fetch('/delete_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                            question_id: Number(questionId)
                        })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showError(data.message || 'Failed to delete question');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }
        
        // View question details
        async function viewQuestion(questionId) {
            const modal = document.getElementById('questionModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalBody.innerHTML = '<div class="spinner"></div>';
            modal.style.display = 'flex';

            try {
                const response = await fetch(`/get_question_details/${questionId}`);
                const data = await response.json();

                if (data.success) {
                    const questionSet = data.question;
                    modalTitle.textContent = `Details for: ${questionSet.query}`;
                    
                    let questionsHtml = '<div class="questions-grid">';
                    questionSet.questions_data.forEach((q, index) => {
                        // URL is already validated by backend - use it directly
                        const problemUrl = q.url || '#';
                        
                        questionsHtml += `
                            <div class="question-card">
                                <div class="question-header">
                                    <span class="question-number">${index + 1}</span>
                                    <div class="platform-badge platform-${q.platform.toLowerCase().replace(' ', '-')}">
                                        ${q.platform}
                                    </div>
                                </div>
                                <div class="question-content">
                                    <h4 class="question-topic">${q.topic}</h4>
                                    <p class="question-category">${q.category}</p>
                                </div>
                                <div class="question-meta">
                                    <div class="difficulty difficulty-${q.difficulty_level.toLowerCase()}">
                                        <i class="fas fa-signal"></i>
                                        ${q.difficulty_level}
                                    </div>
                                    <div class="company">
                                        <i class="fas fa-building"></i>
                                        ${q.company}
                                    </div>
                                </div>
                                <a href="${problemUrl}" target="_blank" rel="noopener noreferrer" class="question-link">
                                    <i class="fas fa-external-link-alt"></i>
                                    View Problem
                                </a>
                            </div>
                        `;
                    });
                    questionsHtml += '</div>';
                    modalBody.innerHTML = questionsHtml;
                } else {
                    modalBody.innerHTML = `<p class="error-message">${data.error || 'Could not load details.'}</p>`;
                }
            } catch (error) {
                modalBody.innerHTML = `<p class="error-message">Network error. Please try again.</p>`;
            }
        }
        
        function closeModal() {
            document.getElementById('questionModal').style.display = 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorText = document.getElementById('errorMessage');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            // Create a temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>
